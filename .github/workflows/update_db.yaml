name: Update Database

on:
  workflow_dispatch:

jobs:
  update_db:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 jq zstd

      - name: Run update_db.py
        env:
          DEPLOYMENT_ID_1: ${{ secrets.DEPLOYMENT_ID_1 }}
          DEPLOYMENT_ID_2: ${{ secrets.DEPLOYMENT_ID_2 }}
        run: python update_db.py

      # - name: SQLite hygiene
      #   run: |
      #     sqlite3 database/database.sqlite <<'EOF'
      #     PRAGMA journal_mode=DELETE;
      #     PRAGMA synchronous=OFF;
      #     PRAGMA temp_store=MEMORY;
      #     VACUUM;
      #     EOF

      - name: Generate checksums and sizes
        run: |
          sha256sum database/database.sqlite > database/database.sqlite.sha256
          echo "DB_SIZE=$(stat -c%s database/database.sqlite)" >> $GITHUB_ENV
          echo "DB_SHA256=$(cut -d ' ' -f1 database/database.sqlite.sha256)" >> $GITHUB_ENV

      - name: Compress SQLite (overwrite if exists)
        run: |
          zstd -19 -f database/database.sqlite -o database/database.sqlite.zst

      - name: Commit database changes (if any)
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add database db_version.json
          git diff --cached --quiet || (git commit -m "Update database and version" && git push)

      - name: Read DB version
        run: echo "DB_VERSION=$(jq -r .version db_version.json)" >> $GITHUB_ENV

      - name: Create metadata.json
        run: |
          GENERATED_AT=$(TZ=Asia/Dubai date '+%d-%m-%Y %H:%M:%S GMT+4')

          cat <<EOF > metadata.json
          {
            "version": "${DB_VERSION}",
            "files": {
              "sqlite": {
                "name": "database.sqlite",
                "size": ${DB_SIZE},
                "sha256": "${DB_SHA256}"
              },
              "sqlite_zst": {
                "name": "database.sqlite.zst"
              }
            },
            "generated_at": "${GENERATED_AT}"
          }
          EOF

      - name: Create Git tag (auto-increment if exists)
        run: |
          VERSION="${DB_VERSION}"
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"

          while git ls-remote --tags https://github.com/${OWNER}/${REPO}.git "v${VERSION}" | grep -q "v${VERSION}"; do
            echo "Tag v${VERSION} already exists. Incrementing..."
            # Increment patch number
            PATCH=$(echo "$VERSION" | awk -F. '{print $NF}')
            BASE=$(echo "$VERSION" | sed "s/\.[0-9]*$//")
            PATCH=$((PATCH + 1))
            VERSION="${BASE}.${PATCH}"
          done

          echo "Using tag: v${VERSION}"
          git tag "v${VERSION}"
          git push origin "v${VERSION}"

          # Export the final tag for later steps
          echo "DB_TAG=${VERSION}" >> $GITHUB_ENV

          
      - name: Set release timestamp
        run: |
          RELEASE_TS=$(TZ=Asia/Dubai date '+%d-%m-%Y %H:%M:%S GMT+4')
          echo "RELEASE_TS=${RELEASE_TS}" >> $GITHUB_ENV


      - name: Create GitHub Release with assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create v${DB_TAG} \
            database/database.sqlite \
            database/database.sqlite.zst \
            metadata.json \
            --title "Database v${DB_TAG}" \
            --notes "Automated database release\nRelease time: ${RELEASE_TS}"

      - name: Update latest pointer
        run: |
          UPDATED_AT=$(TZ=Asia/Dubai date '+%d-%m-%Y %H:%M:%S GMT+4')

          cat <<EOF > latest.json
          {
            "latest": "${DB_VERSION}",
            "updated_at": "${UPDATED_AT}"
          }
          EOF

          git add latest.json
          git commit -m "⚡️ ${DB_VERSION} at ${UPDATED_AT}"
          git push
