name: Update Database

on:
  workflow_dispatch:

jobs:
  update_db:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 jq zstd

      - name: Run update_db.py
        env:
          DEPLOYMENT_ID_1: ${{ secrets.DEPLOYMENT_ID_1 }}
          DEPLOYMENT_ID_2: ${{ secrets.DEPLOYMENT_ID_2 }}
        run: python update_db.py

      - name: SQLite hygiene
        run: |
          sqlite3 database/database.sqlite <<'EOF'
          PRAGMA journal_mode=DELETE;
          PRAGMA synchronous=OFF;
          PRAGMA temp_store=MEMORY;
          VACUUM;
          EOF

      - name: Generate checksums and sizes
        run: |
          sha256sum database/database.sqlite > database/database.sqlite.sha256
          echo "DB_SIZE=$(stat -c%s database/database.sqlite)" >> $GITHUB_ENV
          echo "DB_SHA256=$(cut -d ' ' -f1 database/database.sqlite.sha256)" >> $GITHUB_ENV

      - name: Compress SQLite (keep original)
        run: |
          zstd -19 database/database.sqlite -o database/database.sqlite.zst

      - name: Commit database changes (if any)
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add database db_version.json
          git diff --cached --quiet || (git commit -m "Update database and version" && git push)

      - name: Read DB version
        run: echo "DB_VERSION=$(jq -r .version db_version.json)" >> $GITHUB_ENV

      - name: Create metadata.json
        run: |
          cat <<EOF > metadata.json
          {
            "version": "${DB_VERSION}",
            "files": {
              "sqlite": {
                "name": "database.sqlite",
                "size": ${DB_SIZE},
                "sha256": "${DB_SHA256}"
              },
              "sqlite_zst": {
                "name": "database.sqlite.zst"
              }
            },
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Create Git tag
        run: |
          git tag v${DB_VERSION}
          git push origin v${DB_VERSION}

      - name: Create GitHub Release with assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create v${DB_VERSION} \
            database/database.sqlite \
            database/database.sqlite.zst \
            metadata.json \
            --title "Database v${DB_VERSION}" \
            --notes "Automated database release"

            - name: Update latest pointer
          run: |
          UPDATED_AT=$(TZ=Asia/Dubai date '+%d-%m-%Y %H:%M:%S GMT+4')

          cat <<EOF > latest.json
          {
            "latest": "${DB_VERSION}",
            "updated_at": "${UPDATED_AT}"
          }
          EOF

          git add latest.json
          git commit -m "Update latest release pointer"
          git push
